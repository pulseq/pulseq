%% init the music variables

mrMusic.init('a_init', 460, ...  % tuned for avoiding resonances on CimaX
    'temperament','meantone/4'); % 'BachWellTempered' %'meantone/4' 'Bach-Lehman'

%% melody definition

barDurationSeconds=2; 
timeSignature = 2/4;

% Banereie by J.S.Bach
% 3-voice MRI converted from an unspecified 4-voice clarinet version from the internet 
melody = {
    % bar 1
    [ o/4 h2/8  d3/16 h2/16 ],...
    [ o/4 d2/8  o/8         ],...
    [ o/4 hbb/8 hbb/8       ];...

    % bar 2
    [ fis2/8 h2/16 fis2/16 d2/8   fis2/16 d2/16 ], ...
    [ h1/8   o/8           fis1/8 o/8         ], ...
    [ db/8   hbb/8         fisb/8 db/8        ]; ...

    % bar 3
    [ h1/4          fis1/16 h1/16 d2/16  h1/16 ], ...
    [ fis1/4        fis1/8        fis1/8       ], ...
    [ hb/8   fisb/8 db/8          hbb/8        ]; ...

    % bar 4
    [ cis2/16 h1/16 cis2/16 h1/16 ais1/16 cis2/16 e2/16 cis2/16 ], ...
    [ g1/8          e1/8          fis1/8          ais1/8        ], ...
    [ eb/8          cisb/8        fisb/8          gbb/8         ]; ...

    % bar 5
    [ -d2/8           h1/8          h2/8 d3/16 h2/16 ], ...
    [  h1/8           fis1/8        d2/8  o/8        ], ...
    [  hbb/16 cisb/16 db/16 cisb/16 hbb/8 hbb/8      ]; ...

    % bar 6
    [ fis2/8 h2/16 fis2/16 d2/8   fis2/16 d2/16 ], ...
    [ h1/8   o/8           fis1/8 o/8           ], ...
    [ db/8   hbb/8         fisb/8 db/8          ]; ...

    % bar 7
    [ h1/4          d2/8   d2/8         ], ...
    [ fis1/4        fis1/8 fis1/8       ], ...
    [ hb/8   fisb/8 hb/8   d1/16  hb/16 ]; ...

    % bar 8
    [ d2/8    d2/8         h2/8   d2/8          ], ...
    [ e1/8   gis1/8        gis1/8 e1/8          ], ...
    [ gisb/8 hb/16 gisb/16 eb/8   gisb/16 eb/16 ]; ...

    % bar 9
    [ -d2/8 cis2/8        fis2/8 fis2/8      ], ... % legato in the first two notes 
    [  e1/8 e1/8          fis1/8 a1/8        ], ...
    [  ab/8 cisb/16 ab/16 d1/8   h1/16 d1/16 ]; ...

    % bar 10
    [ fis2/8 fis2/8       d3/8   fis2/8         ], ...
    [ gis1/8 gis1/8       h1/8   gis1/8         ], ...
    [ hb/8   d1/16  hb/16 gisb/8 hb/16  gisb/16 ]; ...

    % bar 11
    [ -fis2/8        f2/8          cis2/16 fis2/16 a2/16 fis2/16 ], ... % legato in the first two notes
    [  gis1/8        gis1/8        fis1/8          a1/8          ], ...
    [  cis1/16 d1/16 cis1/16 hb/16 ab/8            fisb/8        ]; ...

    % bar 12
    [gis2/16 fis2/16 gis2/16 fis2/16 f2/16 gis2/16 h2/16 gis2/16 ], ...
    [h1/8            h1/8            gis1/8        gis1/8        ], ...
    [hb/8            gisb/8          cis1/8        cb/8          ]; ...

    % bar 13
    [ a2/16 gis2/16 a2/16 gis2/16 fis2/16 a2/16 -fis2/16 -f2/16 ], ... % legato in the last two notes and over to the first in the next bar
    [ a1/8          a1/8          a1/8           fis1/8         ], ...
    [ fisb/8        fisbb/8       fisb/8         ab/8           ]; ...

    % bar 14
    [ fis2/16 h2/16 -fis2/16 -eis2/16 -fis2/16 cis3/16 -fis2/16 -eis2/16 ], ... % legato in the first note, between the third and the fifth and between the last two and the first one of the next bar 
    [ ab/8           ab/8              ab/8             ab/8             ], ...
    [ db/8           hb/8              cisb/8           cis1/8           ]; ...

    % bar 15
    [ fis2/16 d3/16 fis2/16 -eis2/16 -fis2/16 d3/16 cis3/16 h2/16 ], ...
    [ gis1/8        gis1/8            gis1/8        fis1/8        ], ...
    [ hbb/8         d1/8              hb/8          gisb/8        ]; ...

    % bar 16
    [ cis3/16 a2/16 gis2/16 fis2/16 a2/8   gis2/8 ], ...
    [ fis1/8        fis1/8          a1/8   h1/8   ], ...
    [ ab/8          hb/8            cis1/8 cisb/8 ]; ...

    % bar 17 --> repeat from 2, skip on repeat
    [ fis2/4 h2/8  d3/16 h2/16 ], ...
    [ a1/4   d2/8  o/8         ], ...
    [ fisb/4 hbb/8 hbb/8       ]; ...

    % bar 18 
    [ fis2/4 fis2/8  a2/16 fis2/16 ], ...
    [ a1/4   a1/8    o/8           ], ...
    [ fisb/4 fisbb/8 fisbb/8        ]; ...

    % bar 19
    [ cis2/8 fis2/16 cis2/16 a1/8   cis2/16 a1/16 ], ...
    [ fis1/8 o/8             fis1/8 o/8           ], ...
    [ abb/8  fisbb/8         cisb/8 abb/8         ]; ...

    % bar 20
    [ fis1/4              -c2/8   h1/8            ], ... % [ fis1/8 o/8          -c2/8   h1/8            ], 
    [ cis1/8 o/8           fis1/8 o/8             ], ...
    [ fisb/8 ab/16 fisb/16 disb/8 fisb/16 disb/16 ]; ...

    % bar 21
    [ -e2/8  dis2/16 fis2/16 a2/8   g2/16 fis2/16 ], ...
    [  g1/8  o/8             fis1/8 o/8           ], ...
    [  hbb/8 hbb/8           hbb/8  hbb/8         ]; ...

    % bar 22
    [ -g2/8 e2/8 g2/8   h2/16 g2/16       ], ...
    [  g1/8 o/8  e2/8   o/8               ], ...
    [  eb/8 hb/16 gb/16 eb/8  gb/16 eb/16 ]; ...

    % bar 23
    [ e2/8   g2/16 e2/16 cis2/8 e2/16 cis2/16 ], ...
    [ cis2/8 o/8         a1/8   o/8           ], ...
    [ cisb/8 abb/8       eb/8   cisb/8        ]; ...

    % bar 24
    [ -a1/4      a1/16 d2/16 fis2/16 d2/16], ... % [ -a1/4      a1/16 d2/16 fis2/16 d2/16]
    [  e1/8 o/8  a1/8        fis1/8       ], ...
    [  gb/8 eb/8 fisb/8      hb/8         ]; ...

    % bar 25
    [ e2/16 d2/16 e2/16 d2/16 cis2/16 e2/16 g2/16 e2/16 ], ...
    [ h1/8        g1/8        d1/8          g1/8        ], ...
    [ gb/8        eb/8        ab/8          abb/8       ]; ...

    % bar 26
    [ fis2/16 e2/16 fis2/16 e2/16 d2/16 fis2/16 -d2/16 -cis2/16 ], ...
    [ fis1/8        fis1/8        fis1/8         a1/8           ], ... 
    [ db/8          dbb/8         cb/8           fisb/8         ]; ...

    % bar 27
    [ d2/16 g2/16 -d2/16 -cis2/16 d2/16 a2/16 -d2/16 -cis2/16 ], ...
    [ g1/8         g1/8           fis1/8       fis1/8         ], ...
    [ hbb/8        gb/8           abb/8        ab/8           ]; ...

    % bar 28
    [ d2/16 h2/16 -d2/16 -cis2/16 d2/16 h2/16 a2/16 g2/16 ], ...
    [ e1/8         e1/8           g1/8        g1/8          ], ...
    [ gbb/8        hb/8           gb/8        eb/8          ]; ...

    % bar 29
    [ a2/16 fis2/16 e2/16 d2/16 fis2/8 e2/8  ], ...
    [ a1/8          g1/8        fis1/8 g1/8  ], ...
    [ fisb/8        gb/8        ab/8   abb/8 ]; ...

   % bar 30
    [ d2/4                 fis2/8 fis2/8       ], ...
    [ fis1/4               o/4                 ], ...
    [ db/8 abb/16 fisbb/16 dbb/8  db/16 abb/16 ]; ...

    % bar 31
    [ fis2/8 fis2/8         d3/8 fis2/8        ], ...
    [ o/2                                      ], ...
    [ fisbb/8 ab/16 fisb/16 db/8 fisb/16 db/16 ]; ...

    % bar 32
    [ -fis2/8 e2/8          e2/8    e2/8 ], ...
    [  o/2                                        ], ...
    [  ab/8   eb/16 cisb/16 aisbb/8 eb/16 cisb/16 ]; ...

    % bar 33
    [ e2/8    e2/8             cis3/8  e2/8              ], ...
    [ o/2                                                ], ...
    [ aisbb/8 cisb/16 aisbb/16 fisbb/8 aisbb/16 fisbb/16 ]; ...

    % bar 34
    [ -e2/8 d2/8     h2/8   d3/16 h2/16 ], ...
    [  o/4           fis1/8 o/8         ], ...
    [  hbb/8 fisbb/8 db/8   hb/8        ]; ...

    % bar 35
    [ -a2/64 -g2*15/64  g2/8 -h2/32 -a2/32 -g2/32 -fis2/32 ], ... %[ a2/8 -e2/8        e2/8 -h2/32 -a2/32 -g2/32 -fis2/32 ]
    [ g1/8  h1/16 g1/16 e1/8  o/8                          ], ...
    [ eb/8  eb/8        eb/8  ebb/8                        ]; ...

    % bar 36
    [ -e2/4             e2/8 -g2/32 -fis2/32 -e2/32 -d2/32 ], ...
    [  o/8  h1/16 g1/16 e1/8  o/8                          ], ...
    [  eb/8 eb/8        eb/8  ebb/8                        ]; ...

    % bar 37 check from here #35
    [ c2/16 e2/16 g2/16 e2/16 -c2/16 h1/16 -c2/16 h1/16 ], ...
    [ o/8         g1/8         g1/8         g1/8        ], ...
    [ eb/8        eb/8         eb/8         ebb/8       ]; ...

    % bar 38
    [ ais1/8 fis1/8       -g1/8    fis1/8           ], ...
    [ fis1/8 fis1/8       -g1/8    fis1/8           ], ...
    [ eb/8   eb/16 cisb/16 aisbb/8 cisb/16 aisbb/16 ]; ...

    % bar 39
    [ -h1/8    ais1/16 cis2/16 e2/8    d2/16 cis2/16 ], ...
    [  d1/8    o/8             e1/8    o/8           ], ...
    [  fisbb/8 fisbb/8         fisbb/8 fisbb/8       ]; ...

    % bar 40
    [ d2/8 -h1/32 -cis2/32 -d2/32 -e2/32 -fis2/8  d2/16  fis2/16  ], ...
    [ d1/8  fis1/16         h1/16         d2/8    h2/16  d2/16    ], ...
    [ hbb/8 db/16           hbb/16        fisbb/8 hbb/16 fisbb/16 ]; ...

    % bar 41
    [ h2/8   fis2/8      -e2/16 d2/16 cis2/16 d2/16 ], ...
    [ fis2/8 d2/8         h1/8        ais1/8        ], ...
    [ dbb/8  hbb/16 db/16 fisb/8      fisbb/8       ]; ...

    % bar 42
    [   h1/4        fis2/8  a2/16 fis2/16 ]*1.1, ... % slow down a bit (by 10%) 
    [  -h1/8    o/8 a1/8    o/8           ]*1.1, ...
    [  -hbb/8  hbb/8  fisbb/8 fisbb/8     ]*1.1; ...

    % need to slow down, otherwise it sounds really ugly
    % % bar 43
    % [ h2/8   fis2/8      -e2/16 d2/16 -cis2/16 d2/16 ], ...
    % [ fis2/8 d2/8         h1/8         ais1/8        ], ...
    % [ dbb/8  hbb/16 db/16 fisb/8       fisbb/8       ]; ...
    % 
    % % bar 44
    % [  -d2/64 -h1*7/64 h1/4   o/8 ], ... %
    % [  -hb/8           hb/4   o/8 ], ...
    % [  -hbb/8          hbb/4  o/8 ]; ...

    % bar 43
    [ h2/8   fis2/8      -e2/16 d2/16 -cis2/16 d2/16 ]*1.2, ... % slow down by 20%
    [ fis2/8 d2/8         h1/8         ais1/8        ]*1.2, ...
    [ dbb/8  hbb/16 db/16 fisb/8       fisbb/8       ]*1.2; ...

    % bar 44
    [  -d2/64 -h1*7/64 h1/4   o/8 ]*1.5, ... % slow down by 50%
    [  -hb/8           hb/4   o/8 ]*1.5, ...
    [  -hbb/8          hbb/4  o/8 ]*1.5; ...
};    

    % % bar X
    % [], ...
    % [], ...
    % []; ...

% handle repeat of the bars 2-16 between 17 and 18
%ml=size(melody,1);
melody=melody([1:17 2:16 18:42 19:40 43 44 ],:);
%melody=melody([1:17 2:16 18:40],:); %b24?

%% convert to the channel-frequency table

[pitches, durations] = mrMusic.melodyToPitchesAndDurations(melody,'timeSignature',timeSignature,'defaultArticulation','non-legato');

%% Pulseq sequence 

% never use full gradient performance because it is almost impossible to
% avoid the mechanical resonances of the gradient system completely
sys = mr.opts('MaxGrad',18,'GradUnit','mT/m',...
    'MaxSlew',160,'SlewUnit','T/m/s',...
    'rfRingdownTime', 20e-6, 'rfDeadtime', 100e-6 ...
);  
seq=mr.Sequence(sys);      % Create a new sequence object

pulseqUseWave=false; % use the "UseWave" option with case as it is really demanding both on the Pulseq environment and the scanner (shape memory)

seq = mrMusic.musicToSequence(seq, pitches, durations, ...
    'barDurationSeconds', barDurationSeconds, ...
    'pulseqUseWave', pulseqUseWave, ...
    'axesOrder', 'zxy');

%% output
if pulseqUseWave
    seq.setDefinition('Name', 'badinerie');
    seq.write('badinerie.seq');
else
    seq.setDefinition('Name', 'badinerie1');
    seq.write('badinerie1.seq');
end

return
%% play

seq.sound([1,1,1]);

return
%% optional slow step for checking whether we are staying within slew rate limits  

rep = seq.testReport; 
fprintf([rep{:}]); 
